#PBS -N qcmd-@PORT@
#PBS -q l16 -l walltime=004:00:00
export SCR=/scratch/gt317
cd $SCR
mkdir $PBS_JOBID
cd $PBS_JOBID
export INFOFILE=${PBS_O_WORKDIR}/qcmd-@PORT@.info
#
# Write out some helpful info to the output file
#
echo "Starting job $PBS_JOBID"
echo
echo "PBS assigned me this node:"
cat $PBS_NODEFILE
echo "Starting job $PBS_JOBID" > ${INFOFILE}
echo >> ${INFOFILE}
echo "PBS assigned me this node:" >> ${INFOFILE} 
cat $PBS_NODEFILE >> ${INFOFILE} 
echo

#copy startup files to the working directory
cp ${PBS_O_WORKDIR}/input.xml ./
cp ${PBS_O_WORKDIR}/init.xyz ./

#start the program
export FFADDRESS="pswater@PORT@"
rm -f /tmp/ipi_${FFADDRESS}
i-pi input.xml > log.txt &
sleep 5
for i in {1..@NB@}; do
  i-pi-driver -m pswater -u -h ${FFADDRESS} &
done
wait

#mv the files back
cp * $PBS_O_WORKDIR
STATUS=$?
echo "$STATUS"

if [ $STATUS == 0 ];
   then
      echo "No error in cp"
      cd $PBS_O_WORKDIR
      rm -rf $SCR/$PBS_JOBID
fi

# Write out the PBS details of the job. If it ran for any sensible length
# of time this will tell you the CPU, walltime, and memory usage.
echo "Job finished. PBS details are:" >> ${INFOFILE}
qstat -f $PBS_JOBID >> ${INFOFILE} 
echo Finished at `date` >> ${INFOFILE}
